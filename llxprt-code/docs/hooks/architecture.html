<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hook System Architecture | LLxprt Code Docs</title>
  <link rel="stylesheet" href="../../../vybestack.css" />
</head>
<body>

  <nav>
    <div class="nav-container">
      <div class="nav-left">
        <a href="/" class="logo">
          <img src="/assets/vybestack_logo.png" alt="Vybestack" />
        </a>
        <span class="tagline">Beyond Vibe Coding</span>
      </div>
      <div class="nav-right">
        <div class="nav-dropdown">
          <a href="/llxprt-code.html">LLxprt Code</a>
          <div class="nav-dropdown-menu">
            <a href="/llxprt-code.html">Overview</a>
            <a href="/llxprt-code/docs/">Documentation</a>
          </div>
        </div>
        <a href="/jefe.html">LLxprt Jefe</a>
        <a href="/blog/">Blog</a>
        <a href="/#podcast">Podcast</a>
        <a href="https://discord.gg/Wc6dZqWWYv" target="_blank">Discord</a>
      </div>
    </div>
  </nav>


  <section class="section docs-section">
    <div class="container-wide">
      <div class="docs-layout">

      <nav class="docs-sidebar">
        <h3><a href="/llxprt-code/docs/">Documentation</a></h3>
        <ul>
          <li><a href="/llxprt-code/docs/getting-started.html">Getting Started Guide</a></li>
          <li><a href="/llxprt-code/docs/cli/providers.html">Provider Configuration</a></li>
          <li><a href="/llxprt-code/docs/cli/authentication.html">Authentication</a></li>
          <li><a href="/llxprt-code/docs/cli/profiles.html">Profiles</a></li>
          <li><a href="/llxprt-code/docs/sandbox.html">Sandboxing</a></li>
          <li><a href="/llxprt-code/docs/subagents.html">Subagents</a></li>
          <li><a href="/llxprt-code/docs/oauth-setup.html">OAuth Setup</a></li>
          <li><a href="/llxprt-code/docs/local-models.html">Local Models</a></li>
          <li><a href="/llxprt-code/docs/zed-integration.html">Zed Editor Integration</a></li>
          <li><a href="/llxprt-code/docs/cli/providers-openai-responses.html">OpenAI Responses API</a></li>
          <li><a href="/llxprt-code/docs/prompt-configuration.html">Prompt Configuration</a></li>
          <li><a href="/llxprt-code/docs/settings-and-profiles.html">Settings and Profiles</a></li>
          <li><a href="/llxprt-code/docs/checkpointing.html">Checkpointing</a></li>
          <li><a href="/llxprt-code/docs/extension.html">Extensions</a></li>
          <li><a href="/llxprt-code/docs/ide-integration.html">IDE Integration</a></li>
          <li><a href="/llxprt-code/docs/cli/configuration.html">Configuration</a></li>
          <li><a href="/llxprt-code/docs/cli/commands.html">Commands Reference</a></li>
          <li><a href="/llxprt-code/docs/troubleshooting.html">Troubleshooting Guide</a></li>
          <li><a href="/llxprt-code/docs/cli/index.html">CLI Introduction</a></li>
          <li><a href="/llxprt-code/docs/deployment.html">Execution and Deployment</a></li>
          <li><a href="/llxprt-code/docs/keyboard-shortcuts.html">Keyboard Shortcuts</a></li>
          <li><a href="/llxprt-code/docs/cli/themes.html">Themes</a></li>
          <li><a href="/llxprt-code/docs/EMOJI-FILTER.html">Emoji Filter</a></li>
          <li><a href="/llxprt-code/docs/cli/runtime-helpers.html">Runtime helper APIs</a></li>
          <li><a href="/llxprt-code/docs/cli/context-dumping.html">Context Dumping</a></li>
          <li><a href="/llxprt-code/docs/telemetry.html">Telemetry</a></li>
          <li><a href="/llxprt-code/docs/telemetry-privacy.html">Telemetry Privacy</a></li>
          <li><a href="/llxprt-code/docs/gemini-cli-tips.html">Migration from Gemini CLI</a></li>
          <li><a href="/llxprt-code/docs/architecture.html">Architecture Overview</a></li>
          <li><a href="/llxprt-code/docs/core/index.html">Core Introduction</a></li>
          <li><a href="/llxprt-code/docs/core/provider-runtime-context.html">Provider runtime context</a></li>
          <li><a href="/llxprt-code/docs/core/provider-interface.html">Provider interface</a></li>
          <li><a href="/llxprt-code/docs/core/tools-api.html">Tools API</a></li>
          <li><a href="/llxprt-code/docs/core/memport.html">Memory Import Processor</a></li>
          <li><a href="/llxprt-code/docs/shell-replacement.html">Shell Replacement</a></li>
          <li><a href="/llxprt-code/docs/../CONTRIBUTING.html">Contributing & Development Guide</a></li>
          <li><a href="/llxprt-code/docs/npm.html">NPM Workspaces and Publishing</a></li>
          <li><a href="/llxprt-code/docs/migration/stateless-provider.html">Stateless provider migration</a></li>
          <li><a href="/llxprt-code/docs/tools/index.html">Tools Overview</a></li>
          <li><a href="/llxprt-code/docs/tools/file-system.html">File System Tools</a></li>
          <li><a href="/llxprt-code/docs/tools/multi-file.html">Multi-File Read Tool</a></li>
          <li><a href="/llxprt-code/docs/tools/shell.html">Shell Tool</a></li>
          <li><a href="/llxprt-code/docs/tools/mcp-server.html">MCP Server</a></li>
          <li><a href="/llxprt-code/docs/tools/web-fetch.html">Web Fetch Tool</a></li>
          <li><a href="/llxprt-code/docs/tools/web-search.html">Web Search Tool</a></li>
          <li><a href="/llxprt-code/docs/tools/memory.html">Memory Tool</a></li>
          <li><a href="/llxprt-code/docs/release-notes/stateless-provider.html">Release notes: Stateless Provider</a></li>
          <li><a href="/llxprt-code/docs/tos-privacy.html">Terms of Service and Privacy Notice</a></li>
        </ul>
      </nav>
        <div class="docs-content">
          <div class="blog-post-content">
            <h1>Hook System Architecture</h1>
<p>This guide explains how the LLxprt Code hook system works internally, which helps you write more effective hooks and debug issues.</p>
<h2>System Overview</h2>
<p>The hook system consists of five main components:</p>
<pre><code class="language-text">┌─────────────────────────────────────────────────────────────────┐
│                        HookSystem                                │
│  (Owns all components, provides lazy initialization)            │
└───────────────────────────┬─────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  HookRegistry │   │  HookPlanner  │   │ HookRunner    │
│  (Stores all  │   │  (Selects     │   │ (Executes     │
│   configured  │──▶│   matching    │──▶│  scripts via  │
│   hooks)      │   │   hooks)      │   │  subprocess)  │
└───────────────┘   └───────────────┘   └───────┬───────┘
                                                │
                                                ▼
                                        ┌───────────────┐
                                        │HookAggregator │
                                        │ (Merges       │
                                        │  results)     │
                                        └───────────────┘
</code></pre>
<h3>Component Responsibilities</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HookSystem</strong></td>
<td>Entry point. Manages initialization, owns all sub-components</td>
</tr>
<tr>
<td><strong>HookRegistry</strong></td>
<td>Stores hook configurations, provides lookup by event</td>
</tr>
<tr>
<td><strong>HookPlanner</strong></td>
<td>Creates execution plans, applies matchers, handles deduplication</td>
</tr>
<tr>
<td><strong>HookRunner</strong></td>
<td>Spawns subprocess, sends JSON to stdin, reads stdout/stderr</td>
</tr>
<tr>
<td><strong>HookAggregator</strong></td>
<td>Merges outputs from multiple hooks using event-specific strategies</td>
</tr>
</tbody>
</table>
<h2>Execution Flow</h2>
<p>When a hook event fires, here's what happens:</p>
<h3>1. Event Trigger</h3>
<pre><code class="language-typescript">// Example: Tool execution triggers BeforeTool
const result = await hookSystem
  .getEventHandler()
  .fireBeforeToolEvent('write_file', { path: '/etc/passwd', content: '...' });
</code></pre>
<h3>2. Planning Phase</h3>
<p>The <code>HookPlanner</code> creates an execution plan:</p>
<ol>
<li>Look up all hooks registered for the event (<code>BeforeTool</code>)</li>
<li>Apply matchers to filter hooks (e.g., <code>matcher: &quot;write_*&quot;</code> only runs for write tools)</li>
<li>Sort by priority (Project &gt; Extensions)</li>
<li>Determine execution mode (parallel or sequential)</li>
</ol>
<h3>3. Execution Phase</h3>
<p>The <code>HookRunner</code> executes each hook:</p>
<ol>
<li>Build the input payload (JSON)</li>
<li>Spawn the hook command as a subprocess</li>
<li>Write input JSON to stdin</li>
<li>Read stdout and stderr</li>
<li>Wait for exit (with timeout)</li>
<li>Parse JSON output or convert plain text</li>
</ol>
<h3>4. Aggregation Phase</h3>
<p>The <code>HookAggregator</code> combines results using event-specific strategies:</p>
<table>
<thead>
<tr>
<th>Event Type</th>
<th>Aggregation Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td>BeforeTool/AfterTool</td>
<td>OR logic: any &quot;block&quot; wins</td>
</tr>
<tr>
<td>BeforeModel/AfterModel</td>
<td>Last write wins (field replacement)</td>
</tr>
<tr>
<td>BeforeToolSelection</td>
<td>UNION of allowed tools; NONE mode wins if any hook uses it</td>
</tr>
</tbody>
</table>
<h2>Hook Input Format</h2>
<p>Every hook receives a JSON object on stdin with these base fields:</p>
<pre><code class="language-typescript">interface HookInput {
  session_id: string; // Unique session identifier
  hook_event_name: string; // e.g., &quot;BeforeTool&quot;
  cwd: string; // Current working directory
  timestamp: string; // ISO 8601 timestamp
  transcript_path: string; // Path to session transcript (if any)
}
</code></pre>
<p>Event-specific fields are added based on the event type. See <a href="./api-reference.html">API Reference</a> for complete schemas.</p>
<h2>Hook Output Format</h2>
<p>Hooks return JSON on stdout with these common fields:</p>
<pre><code class="language-typescript">interface HookOutput {
  // Execution control
  continue?: boolean; // false = stop execution
  stopReason?: string; // Reason for stopping

  // Decision (for permission-based hooks)
  decision?: 'allow' | 'deny' | 'block' | 'ask' | 'approve';
  reason?: string; // Explanation for decision

  // Output control
  suppressOutput?: boolean; // true = hide from user
  systemMessage?: string; // Message to inject

  // Event-specific output
  hookSpecificOutput?: Record&lt;string, unknown&gt;;
}
</code></pre>
<h2>Exit Code Semantics</h2>
<table>
<thead>
<tr>
<th>Exit Code</th>
<th>Meaning</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Success</td>
<td>Hook output is processed normally</td>
</tr>
<tr>
<td>1</td>
<td>Non-blocking error</td>
<td>Warning logged, execution continues</td>
</tr>
<tr>
<td>2</td>
<td>Blocking error</td>
<td>Operation is blocked/denied</td>
</tr>
</tbody>
</table>
<h3>Plain Text Fallback</h3>
<p>If your hook outputs plain text instead of JSON:</p>
<ul>
<li><strong>Exit 0</strong>: Text becomes <code>systemMessage</code> with <code>decision: &quot;allow&quot;</code></li>
<li><strong>Exit 1</strong>: Text becomes warning message</li>
<li><strong>Exit 2</strong>: Text becomes blocking reason with <code>decision: &quot;deny&quot;</code></li>
</ul>
<p>Example:</p>
<pre><code class="language-bash">#!/bin/bash
# This works even without JSON!
echo &quot;Access denied: sensitive directory&quot;
exit 2
</code></pre>
<h2>Matchers</h2>
<p>Matchers filter which hooks run for which operations. The matcher string is compared against context values.</p>
<h3>Tool Name Matching</h3>
<p>For <code>BeforeTool</code> and <code>AfterTool</code> events:</p>
<pre><code class="language-json">{
  &quot;matcher&quot;: &quot;write_*&quot;,
  &quot;hooks&quot;: [...]
}
</code></pre>
<p>This hook only runs for tools starting with <code>write_</code> (like <code>write_file</code>).</p>
<h3>No Matcher (Default)</h3>
<p>If no matcher is specified, the hook runs for all occurrences of that event:</p>
<pre><code class="language-json">{
  &quot;hooks&quot;: [
    {
      &quot;type&quot;: &quot;command&quot;,
      &quot;command&quot;: &quot;./log-all-tools.sh&quot;
    }
  ]
}
</code></pre>
<h2>Sequential vs Parallel Execution</h2>
<p>By default, hooks for an event run in parallel. Set <code>sequential: true</code> for ordered execution:</p>
<pre><code class="language-json">{
  &quot;sequential&quot;: true,
  &quot;hooks&quot;: [
    { &quot;type&quot;: &quot;command&quot;, &quot;command&quot;: &quot;./hook1.sh&quot; },
    { &quot;type&quot;: &quot;command&quot;, &quot;command&quot;: &quot;./hook2.sh&quot; }
  ]
}
</code></pre>
<p>When sequential:</p>
<ul>
<li>Hooks run in order</li>
<li>Each hook can see the output of previous hooks</li>
<li>One hook's output can modify the input for the next</li>
</ul>
<p><strong>Note</strong>: If <em>any</em> hook group for an event sets <code>sequential: true</code>, all hooks for that event run sequentially.</p>
<h2>Timeout Handling</h2>
<p>Each hook has a default timeout of 60 seconds. Configure per-hook:</p>
<pre><code class="language-json">{
  &quot;hooks&quot;: [
    {
      &quot;type&quot;: &quot;command&quot;,
      &quot;command&quot;: &quot;./slow-hook.sh&quot;,
      &quot;timeout&quot;: 120000
    }
  ]
}
</code></pre>
<p>When a hook times out:</p>
<ol>
<li>SIGTERM is sent</li>
<li>After 5 seconds, SIGKILL if still running</li>
<li>Hook result is marked as failed</li>
<li>Execution continues (timeout is not blocking by default)</li>
</ol>
<h2>Error Handling</h2>
<p>The hook system is designed to fail gracefully:</p>
<h3>Hook Script Errors</h3>
<ul>
<li>Non-zero exit (except 2): Logged as warning, execution continues</li>
<li>Exit code 2: Treated as intentional blocking</li>
<li>Unparseable output: Converted to plain text response</li>
</ul>
<h3>Infrastructure Errors</h3>
<ul>
<li>Hook not found: Logged, skipped</li>
<li>Spawn failure: Logged, skipped</li>
<li>Aggregation error: Returns empty success result</li>
</ul>
<p><strong>Philosophy</strong>: A broken hook should not break the entire agent. Errors are logged but don't crash execution.</p>
<h2>Environment Variables</h2>
<p>Hooks receive these environment variables:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LLXPRT_PROJECT_DIR</code></td>
<td>Current working directory</td>
</tr>
<tr>
<td><code>GEMINI_PROJECT_DIR</code></td>
<td>Alias (compatibility)</td>
</tr>
<tr>
<td><code>CLAUDE_PROJECT_DIR</code></td>
<td>Alias (compatibility)</td>
</tr>
</tbody>
</table>
<p>Plus all parent process environment variables.</p>
<h2>MessageBus Integration</h2>
<p>Advanced: The hook system can receive events via the internal MessageBus:</p>
<pre><code class="language-typescript">// Channel: HOOK_EXECUTION_REQUEST
{
  type: 'HOOK_EXECUTION_REQUEST',
  payload: {
    correlationId: string;
    eventName: HookEventName;
    input: HookInput;
  }
}

// Response: HOOK_EXECUTION_RESPONSE
{
  type: 'HOOK_EXECUTION_RESPONSE',
  payload: {
    correlationId: string;
    success: boolean;
    output?: AggregatedHookResult;
    error?: { code: string; message: string };
  }
}
</code></pre>
<p>This is primarily for internal use and extension integration.</p>
<h2>Debugging Hooks</h2>
<p>Enable debug logging to see hook execution:</p>
<pre><code class="language-bash">DEBUG=llxprt:core:hooks:* llxprt
</code></pre>
<p>This shows:</p>
<ul>
<li>Which hooks are selected for each event</li>
<li>Input/output for each hook</li>
<li>Execution timing</li>
<li>Aggregation results</li>
</ul>
<h2>Performance Considerations</h2>
<ol>
<li><strong>Keep hooks fast</strong>: The entire hook phase blocks the agent until all hooks complete</li>
<li><strong>Use matchers</strong>: Don't run hooks for events you don't care about</li>
<li><strong>Prefer parallel</strong>: Sequential is slower</li>
<li><strong>Set appropriate timeouts</strong>: Don't let slow hooks block execution</li>
<li><strong>Exit early</strong>: If you can determine the result quickly, exit immediately</li>
</ol>

          </div>
        </div>
      </div>
    </div>
  </section>


  <footer class="footer">
    <div class="footer-container">
      <div class="footer-section">
        <h4>Vybestack</h4>
        <p>Beyond vibe coding. Autonomous development for ascending engineers.</p>
      </div>
      <div class="footer-section">
        <h4>Products</h4>
        <ul>
          <li><a href="/llxprt-code.html">LLxprt Code</a></li>
          <li><a href="/jefe.html">LLxprt Jefe</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Content</h4>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/#podcast">Podcast</a></li>
          <li><a href="/llxprt-code/docs/">Documentation</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Connect</h4>
        <ul class="social-links">
          <li><a href="https://github.com/vybestack/llxprt-code"><img src="/assets/github-mark-white.svg" alt="GitHub" /> </a></li>
          <li><a href="https://discord.gg/Wc6dZqWWYv"><img src="/assets/discord-mark-white.svg" alt="Discord" /></a></li>
          <li><a href="https://www.linkedin.com/company/vybestack/"><img src="/assets/linkedin-white.svg" alt="LinkedIn" /></a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2026 Vybestack. Apache 2.0 License. Built for the terminal.</p>
    </div>
  </footer>

</body>
</html>