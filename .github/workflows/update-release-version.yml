name: Update Latest Release Version

on:
  schedule:
    # Check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get latest stable release from llxprt-code
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest non-nightly, non-prerelease release
          LATEST=$(gh release list -R vybestack/llxprt-code --limit 100 \
            | grep -v nightly \
            | grep -v beta \
            | grep -v preview \
            | head -1)
          
          TAG=$(echo "$LATEST" | awk '{print $NF}' | head -1)
          # Extract just the tag column (second to last field before the date)
          TAG=$(echo "$LATEST" | awk -F'\t' '{print $3}')
          VERSION=$(echo "$TAG" | sed 's/^v//')
          DATE=$(echo "$LATEST" | awk -F'\t' '{print $4}' | cut -dT -f1)
          
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "Found latest stable release: $TAG ($VERSION) from $DATE"

      - name: Check if version changed
        id: check
        run: |
          CURRENT=""
          if [ -f release-version.json ]; then
            CURRENT=$(cat release-version.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('tag',''))" 2>/dev/null || echo "")
          fi
          if [ "$CURRENT" = "${{ steps.release.outputs.tag }}" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Version unchanged: $CURRENT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Version changed: $CURRENT -> ${{ steps.release.outputs.tag }}"
          fi

      - name: Update release-version.json
        if: steps.check.outputs.changed == 'true'
        run: |
          cat > release-version.json << EOF
          {
            "tag": "${{ steps.release.outputs.tag }}",
            "version": "${{ steps.release.outputs.version }}",
            "date": "${{ steps.release.outputs.date }}"
          }
          EOF

      - name: Update install commands with version
        if: steps.check.outputs.changed == 'true'
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          TAG="${{ steps.release.outputs.tag }}"
          
          # Update the llxprt-code product page install command display
          # Add a version badge/display element if it exists
          sed -i "s|<span id=\"latest-version\">[^<]*</span>|<span id=\"latest-version\">${TAG}</span>|g" llxprt-code.html index.html 2>/dev/null || true

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add release-version.json llxprt-code.html index.html
          git diff --cached --quiet || git commit -m "chore: update latest release to ${{ steps.release.outputs.tag }}"
          git push
