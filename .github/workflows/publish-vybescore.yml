name: Publish VybeScore

on:
  # schedule:
  #   - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      config_mode:
        description: 'Which LLxprt configs should run'
        type: choice
        default: default
        options:
          - default
          - specific
      specific_config:
        description: 'Specific config (if config_mode=specific)'
        required: false
        type: choice
        options:
          - llxprt-synthetic-glm46
          - llxprt-synthetic-minimax
          - llxprt-zai-glm46

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      SYNTHETIC_PROVIDER: ${{ vars.SYNTHETIC_PROVIDER || 'openai' }}
      SYNTHETIC_BASEURL: ${{ vars.SYNTHETIC_BASEURL || 'https://api.synthetic.new/openai/v1' }}
      SYNTHETIC_MODEL: ${{ vars.SYNTHETIC_MODEL || 'hf:zai-org/GLM-4.6' }}
      SYNTHETIC_TEMPERATURE: ${{ vars.SYNTHETIC_TEMPERATURE || 'temperature=1' }}
      SYNTHETIC_CONTEXT_LIMIT: ${{ vars.SYNTHETIC_CONTEXT_LIMIT || 'context-limit=190000' }}
      SYNTHETIC_SHELL_REPLACEMENT: ${{ vars.SYNTHETIC_SHELL_REPLACEMENT || 'shell-replacement=true' }}
      # Cerebras config intentionally omitted (subscription inactive)
      ZAI_MODEL: ${{ vars.ZAI_MODEL || 'glm-4.6' }}
      ZAI_TEMPERATURE: ${{ vars.ZAI_TEMPERATURE || 'temperature=1' }}
      ZAI_CONTEXT_LIMIT: ${{ vars.ZAI_CONTEXT_LIMIT || 'context-limit=190000' }}
      ZAI_SHELL_REPLACEMENT: ${{ vars.ZAI_SHELL_REPLACEMENT || 'shell-replacement=true' }}
      ROLLUP_SKIP_NODE_RESOLUTION: 1
    steps:
      - name: Checkout vybestack-site
        uses: actions/checkout@v4

      - name: Checkout evals repository
        uses: actions/checkout@v4
        with:
          repository: acoliver/evals
          path: evals

      - name: Prime public artifacts with previous publish
        run: |
          mkdir -p evals/public
          if [ -d vybescore ]; then
            rsync -a vybescore/ evals/public/
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        if: |
          github.event_name == 'schedule' || 
          github.event.inputs.run_mode == 'all' || 
          (github.event.inputs.run_mode == 'specific' && !contains(github.event.inputs.specific_config, 'llxprt'))

      - name: Install Code Puppy
        run: pip install code-puppy
        if: |
          github.event_name == 'schedule' || 
          github.event.inputs.run_mode == 'all' || 
          (github.event.inputs.run_mode == 'specific' && !contains(github.event.inputs.specific_config, 'llxprt'))

      - name: Seed Code Puppy config
        run: |
          mkdir -p ~/.code_puppy
          cat <<'EOF' > ~/.code_puppy/puppy.cfg
          [puppy]
          puppy_name = VybePup
          owner_name = CI
          auto_save_session = true
          EOF
        if: |
          github.event_name == 'schedule' || 
          github.event.inputs.run_mode == 'all' || 
          (github.event.inputs.run_mode == 'specific' && !contains(github.event.inputs.specific_config, 'llxprt'))

      - name: Install LLxprt CLI
        run: |
          npm install -g @vybestack/llxprt-code@nightly
          llxprt --version

      - name: Install eval dependencies
        working-directory: evals
        run: |
          npm install
          npm install @rollup/rollup-linux-x64-gnu --no-save || true
          for dir in base64-fix pagination report-builder form-capture regex-challenge react-evaluation; do
            npm --prefix grading/$dir install
            npm --prefix grading/$dir install @rollup/rollup-linux-x64-gnu --no-save || true
          done

      - name: Run LLxprt evaluations
        working-directory: evals
        env:
          SYNTHETIC_KEY: ${{ secrets.SYNTHETIC_KEY }}
          ZAI_KEY: ${{ secrets.ZAI_KEY }}
        run: |
          DEFAULT_CONFIGS=(llxprt-synthetic-glm46 llxprt-synthetic-minimax llxprt-zai-glm46)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.config_mode }}" == "specific" ]]; then
            CONFIGS=("${{ github.event.inputs.specific_config }}")
          else
            CONFIGS=("${DEFAULT_CONFIGS[@]}")
          fi

          ARGS=()
          for config in "${CONFIGS[@]}"; do
            [[ -z "$config" ]] && continue
            ARGS+=("--config" "$config")
          done

          echo "Running npm run eval:all ${ARGS[*]}"
          npm run eval:all -- "${ARGS[@]}"

      - name: Build VybeScore artifacts
        working-directory: evals
        run: npm run build:vybes

      - name: Sync vybescore assets
        run: |
          rm -rf vybescore
          mkdir -p vybescore
          rsync -a --delete evals/public/ vybescore/

      - name: Commit and push updates
        run: |
          git add -A vybescore
          if git diff --cached --quiet -- vybescore; then
            echo "No VybeScore changes to publish."
            exit 0
          fi
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git commit -m "chore: publish VybeScore dashboard"
          git push
